<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<div layout:fragment="content">
    <div class="container">
        <form role="form" method="post" enctype="multipart/form-data" th:object="${itemFormDto}">
            <input type="hidden" th:field="*{id}">
            <div class="form-group">
                <label th:for="itemName">상품명</label>
                <input type="text" th:field="*{itemName}" class="form-control" placeholder="상품명을 입력해주세요">
                <p th:if="${#fields.hasErrors('itemName')}" th:errors="*{itemName}" class="fieldError">Incorrect data</p>
            </div>
            <div class="form-group">
                <label th:for="travelType">여행 타입</label>
                <select th:field="*{travelType}" class="form-control" id="travelType">
                    <option value="">선택해주세요</option>
                    <option th:each="type : ${T(com.soloProject.myTrip.constant.TravelType).values()}"
                            th:value="${type}"
                            th:text="${type.description}">
                    </option>
                </select>
            </div>

            <div class="form-group" id="domesticDiv" style="display: none;">
                <label th:for="domesticCategory">국내여행 지역</label>
                <select th:field="*{domesticCategory}" class="form-control">
                    <option value="">선택해주세요</option>
                    <option th:each="category : ${T(com.soloProject.myTrip.constant.DomesticCategory).values()}"
                            th:value="${category}"
                            th:text="${category.description}">
                    </option>
                </select>
            </div>

            <div class="form-group" id="overseasDiv" style="display: none;">
                <label th:for="overseasCategory">해외여행 지역</label>
                <select th:field="*{overseasCategory}" class="form-control">
                    <option value="">선택해주세요</option>
                    <optgroup th:each="region : ${{'유럽', '아시아', '미주'}}" th:label="${region}">
                        <option th:each="category : ${T(com.soloProject.myTrip.constant.OverseasCategory).values()}"
                                th:if="${category.region == region}"
                                th:value="${category}"
                                th:text="${category.description}">
                        </option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group" id="themeDiv" style="display: none;">
                <label th:for="themeCategory">테마여행 종류</label>
                <select th:field="*{themeCategory}" class="form-control">
                    <option value="">선택해주세요</option>
                    <option th:each="category : ${T(com.soloProject.myTrip.constant.ThemeCategory).values()}"
                            th:value="${category}"
                            th:text="${category.description}">
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label th:for="destination">여행 목적지</label>
                <input type="text" th:field="*{destination}" class="form-control" placeholder="여행 목적지를 입력해주세요">
                <p th:if="${#fields.hasErrors('destination')}" th:errors="*{destination}" class="fieldError">Incorrect data</p>
            </div>
            <div class="form-group">
                <label th:for="duration">여행 기간 (일)</label>
                <input type="number" th:field="*{duration}" class="form-control" placeholder="여행 기간을 일 단위로 입력해주세요">
                <p th:if="${#fields.hasErrors('duration')}" th:errors="*{duration}" class="fieldError">Incorrect data</p>
            </div>
            <div class="form-group">
                <label th:for="price">가격</label>
                <input type="number" th:field="*{price}" class="form-control" placeholder="가격을 입력해주세요">
                <p th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="fieldError">Incorrect data</p>
            </div>
            <div class="form-group">
                <label th:for="itemDetail">상품 상세 내용</label>
                <textarea th:field="*{itemDetail}" class="form-control" placeholder="상품 상세 내용을 입력해주세요"></textarea>
                <p th:if="${#fields.hasErrors('itemDetail')}" th:errors="*{itemDetail}" class="fieldError">Incorrect data</p>
            </div>

            <div class="form-group">
                <label th:for="remainingSeats">잔여 좌석</label>
                <input type="number" th:field="*{remainingSeats}" class="form-control" placeholder="최대 인원을 입력해주세요">
                <p th:if="${#fields.hasErrors('remainingSeats')}" th:errors="*{remainingSeats}" class="fieldError">Incorrect data</p>
            </div>

            <div class="form-group">
                <label th:for="minParticipants">최소 출발 인원</label>
                <input type="number" th:field="*{minParticipants}" class="form-control" placeholder="최소 출발 인원을 입력해주세요">
                <p th:if="${#fields.hasErrors('minParticipants')}" th:errors="*{minParticipants}" class="fieldError">Incorrect data</p>
            </div>

            <!-- 이미지 수정/등록 영역 -->
            <div th:if="${not #lists.isEmpty(itemFormDto.itemImageUrls)}">
                <div class="form-group" id="imageContainer">
                    <div th:each="imageUrl, status : ${itemFormDto.itemImageUrls}" class="image-item mb-3">
                        <div class="form-group">
                            <label th:text="${status.index + 1} + '번째 상품 이미지'"></label>
                            <div class="border p-2">
                                <img th:src="${imageUrl}" class="img-fluid mb-2" style="max-width: 300px;">
                                <input type="file" class="form-control image-input" name="itemImageFile">
                                <input type="hidden" name="originalImageUrls" th:value="${imageUrl}">
                                <button type="button" class="btn btn-outline-danger mt-2" 
                                        th:onclick="deleteImage([[${status.index}]], this)">이미지 삭제</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mt-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="addImageField()">이미지 추가</button>
                    </div>
                </div>
            </div>

            <!-- 새로운 이미지 등록 영역 -->
            <div th:if="${#lists.isEmpty(itemFormDto.itemImageUrls)}">
                <div class="form-group">
                    <div class="image-item">
                        <div class="form-group">
                            <label>상품 이미지</label>
                            <input type="file" class="form-control" name="itemImageFile">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <button type="button" class="btn btn-outline-secondary" onclick="addImageField()">이미지 추가</button>
                </div>
            </div>

            <div style="text-align: center" class="mt-4">
                <button type="button" class="btn btn-primary" onclick="submitForm()">저장</button>
                <button type="button" class="btn btn-danger" onclick="deleteItem()" 
                        th:if="${itemFormDto.id != null}">삭제</button>
                <button type="button" class="btn btn-secondary" onclick="history.back();">취소</button>
            </div>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
    </div>
</div>

<th:block layout:fragment="script">
    <script src="/js/ajaxUtil.js"></script>
    <script th:inline="javascript">
        document.getElementById('travelType').addEventListener('change', function() {
            const domesticDiv = document.getElementById('domesticDiv');
            const overseasDiv = document.getElementById('overseasDiv');
            const themeDiv = document.getElementById('themeDiv');

            // 모든 카테고리 div 숨기기
            domesticDiv.style.display = 'none';
            overseasDiv.style.display = 'none';
            themeDiv.style.display = 'none';

            // 선택된 여행 타입에 따라 해당 카테고리 div 보이기
            switch(this.value) {
                case 'DOMESTIC':
                    domesticDiv.style.display = 'block';
                    break;
                case 'OVERSEAS':
                    overseasDiv.style.display = 'block';
                    break;
                case 'THEME':
                    themeDiv.style.display = 'block';
                    break;
            }
        });

        function submitForm() {
            const form = document.querySelector('form');
            const formData = new FormData(form);
            const itemId = [[${itemFormDto.id}]];
            
            const method = itemId ? 'PATCH' : 'POST';
            const url = itemId ? `/admin/item/${itemId}` : '/admin/item/new';

            $.ajax({
                url: url,
                type: method,
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function(xhr) {
                    const token = $("meta[name='_csrf']").attr("content");
                    const header = $("meta[name='_csrf_header']").attr("content");
                    xhr.setRequestHeader(header, token);
                },
                success: function(result) {
                    alert(itemId ? '상품이 수정되었습니다.' : '상품이 등록되었습니다.');
                    window.location.href = '/admin/items';
                },
                error: function(jqXHR) {
                    alert('처리 중 오류가 발생했습니다.');
                }
            });
        }

        function deleteItem() {
            if (!confirm('정말로 이 상품을 삭제하시겠습니까?')) {
                return;
            }

            const itemId = [[${itemFormDto.id}]];
            ajaxRequest(
                `/admin/item/${itemId}`,
                'DELETE',
                {},
                function(result) {
                    alert('상품이 삭제되었습니다.');
                    window.location.href = '/admin/items';
                }
            );
        }

        function deleteImage(index, button) {
            if (!confirm('이미지를 삭제하시겠습니까?')) {
                return;
            }

            const imageItem = button.closest('.image-item');
            const itemId = [[${itemFormDto.id}]];
            
            ajaxRequest(
                `/admin/item/${itemId}/image/${index}`,
                'DELETE',
                {},
                function(result) {
                    imageItem.remove();
                    reorderImageLabels();
                }
            );
        }

        function reorderImageLabels() {
            const container = document.getElementById('imageContainer');
            const labels = container.getElementsByTagName('label');
            for (let i = 0; i < labels.length; i++) {
                labels[i].textContent = `${i + 1}번째 상품 이미지`;
            }
        }

        function addImageField() {
            const container = document.getElementById('imageContainer');
            const imageItems = container.getElementsByClassName('image-item');
            
            if (imageItems.length >= 5) {
                alert('이미지는 최대 5개까지만 등록 가능합니다.');
                return;
            }

            const newItem = document.createElement('div');
            newItem.className = 'image-item mb-3';
            newItem.innerHTML = `
                <div class="form-group">
                    <label>${imageItems.length + 1}번째 상품 이미지</label>
                    <div class="border p-2">
                        <input type="file" class="form-control image-input" name="itemImageFile">
                        <button type="button" class="btn btn-outline-danger mt-2" onclick="removeImageField(this)">삭제</button>
                    </div>
                </div>
            `;
            container.appendChild(newItem);
        }

        function removeImageField(button) {
            const imageItem = button.closest('.image-item');
            imageItem.remove();
            reorderImageLabels();
        }
    </script>
</th:block>

</html> 