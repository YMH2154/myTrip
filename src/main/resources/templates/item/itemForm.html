<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<th:block layout:fragment="css">
    /* 에러 메시지 스타일링 */
    .fieldError {
    color: #8a2be2;
    font-size: 14px;
    margin-top: 5px;
    }
</th:block>
<div layout:fragment="content">
    <div class="container">
        <form role="form" method="post" enctype="multipart/form-data" th:object="${itemFormDto}">
            <input type="hidden" th:field="*{id}">
            <p class="h2">여행상품 등록</p>
            <div class="form-group">
                <label th:for="itemName">상품명</label>
                <input type="text" th:field="*{itemName}" class="form-control" placeholder="상품명을 입력해주세요">
                <p th:if="${#fields.hasErrors('itemName')}" th:errors="*{itemName}" class="fieldError">Incorrect data</p>
            </div>
            <div class="form-group">
                <label th:for="travelType">여행 타입</label>
                <select th:field="*{travelType}" class="form-control" id="travelType">
                    <option th:each="type : ${T(com.soloProject.myTrip.constant.TravelType).values()}"
                            th:value="${type}"
                            th:text="${type.description}">
                    </option>
                </select>
            </div>

            <div class="form-group" id="domesticDiv" style="display: none;">
                <label th:for="domesticCategory">국내여행 지역</label>
                <select th:field="*{domesticCategory}" class="form-control" id="domesticSel">
                    <option value="">선택해주세요</option>
                    <option th:each="category : ${T(com.soloProject.myTrip.constant.DomesticCategory).values()}"
                            th:value="${category}"
                            th:text="${category.description}">
                    </option>
                </select>
            </div>

            <div class="form-group" id="overseasDiv" style="display: none;">
                <label th:for="overseasCategory">해외여행 지역</label>
                <select th:field="*{overseasCategory}" class="form-control" id="overseasSel">
                    <option value="">선택해주세요</option>
                    <optgroup th:each="region : ${T(com.soloProject.myTrip.constant.OverseasCategory).getUniqueRegions()}"
                              th:label="${region}">
                        <option th:each="category : ${T(com.soloProject.myTrip.constant.OverseasCategory).values()}"
                                th:if="${category.region == region}"
                                th:value="${category}"
                                th:text="${category.description}">
                        </option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group" id="themeDiv" style="display: none;">
                <label th:for="themeCategory">테마여행 종류</label>
                <select th:field="*{themeCategory}" class="form-control" id="themeSel">
                    <option value="">선택해주세요</option>
                    <option th:each="category : ${T(com.soloProject.myTrip.constant.ThemeCategory).values()}"
                            th:value="${category}"
                            th:text="${category.description}">
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label th:for="destination">여행 목적지</label>
                <input type="text" th:field="*{destination}" class="form-control" placeholder="여행 목적지를 입력해주세요">
                <p th:if="${#fields.hasErrors('destination')}" th:errors="*{destination}" class="fieldError">Incorrect data</p>
            </div>
            <div class="form-group">
                <label th:for="duration">여행 기간 (일)</label>
                <input type="number" th:field="*{duration}" class="form-control" placeholder="여행 기간을 일 단위로 입력해주세요">
                <p th:if="${#fields.hasErrors('duration')}" th:errors="*{duration}" class="fieldError">Incorrect data</p>
            </div>
            <div class="form-group">
                <label th:for="price">가격</label>
                <input type="number" th:field="*{price}" class="form-control" placeholder="가격을 입력해주세요">
                <p th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="fieldError">Incorrect data</p>
            </div>
            <div class="form-group">
                <label th:for="itemDetail">상품 상세 내용</label>
                <textarea th:field="*{itemDetail}" class="form-control" placeholder="상품 상세 내용을 입력해주세요"></textarea>
                <p th:if="${#fields.hasErrors('itemDetail')}" th:errors="*{itemDetail}" class="fieldError">Incorrect data</p>
            </div>

            <div class="form-group">
                <label th:for="remainingSeats">최대 인원</label>
                <input type="number" th:field="*{remainingSeats}" class="form-control" placeholder="최대 인원을 입력해주세요">
                <p th:if="${#fields.hasErrors('remainingSeats')}" th:errors="*{remainingSeats}" class="fieldError">Incorrect data</p>
            </div>

            <div class="form-group">
                <label th:for="minParticipants">최소 출발 인원</label>
                <input type="number" th:field="*{minParticipants}" class="form-control" placeholder="최소 출발 인원을 입력해주세요">
                <p th:if="${#fields.hasErrors('minParticipants')}" th:errors="*{minParticipants}" class="fieldError">Incorrect data</p>
            </div>

            <!-- 이미지 수정/등록 영역 -->
            <div th:if="${not #lists.isEmpty(itemFormDto.itemImageUrls)}">
                <div class="form-group image-container" id="editImageContainer">
                    <div th:each="imageUrl, status : ${itemFormDto.itemImageUrls}" class="image-item mb-3">
                        <div class="form-group">
                            <label th:text="${status.index + 1} + '번째 상품 이미지'"></label>
                            <div class="border p-2">
                                <img th:src="${imageUrl}" class="img-fluid mb-2" style="max-width: 300px;">
                                <input type="file" class="form-control image-input" name="itemImageFile">
                                <input type="hidden" name="originalImageUrls" th:value="${imageUrl}">
                                <button type="button" class="btn btn-outline-danger mt-2" 
                                        th:onclick="deleteImage([[${status.index}]], this)">이미지 삭제</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mt-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="addImageField('edit')">이미지 추가</button>
                    </div>
                </div>
            </div>

            <!-- 새로운 이미지 등록 영역 -->
            <div th:if="${#lists.isEmpty(itemFormDto.itemImageUrls)}">
                <div class="form-group image-container" id="newImageContainer">
                    <div class="image-item mb-3">
                        <div class="form-group">
                            <label>1번째 상품 이미지</label>
                            <input type="file" class="form-control" name="itemImageFile">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <button type="button" class="btn btn-outline-secondary" onclick="addImageField('new')">이미지 추가</button>
                </div>
            </div>

            <div style="text-align: center" class="mt-4">
                <button th:if="${#strings.isEmpty(itemFormDto.id)}" 
                        th:action="@{/admin/item/new}"
                        type="submit" 
                        class="btn btn-primary">등록</button>
                <button th:unless="${#strings.isEmpty(itemFormDto.id)}" 
                        th:action="@{'/admin/item/'+${itemFormDto.id}}"
                        type="submit" 
                        class="btn btn-primary">수정</button>
                <button type="button" class="btn btn-secondary" 
                        onclick="goBack();">취소</button>
            </div>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
    </div>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function() {
            const errorMessage = [[${errorMessage}]];
            if(errorMessage != null){
                alert(errorMessage);
            }
        });
        document.addEventListener('DOMContentLoaded', function() {
            const travelTypeSelect = document.getElementById('travelType');
            const domesticDiv = document.getElementById('domesticDiv');
            const overseasDiv = document.getElementById('overseasDiv');
            const themeDiv = document.getElementById('themeDiv');
            
            const domesticSelect = document.querySelector('select[name="domesticCategory"]');
            const overseasSelect = document.querySelector('select[name="overseasCategory"]');
            const themeSelect = document.querySelector('select[name="themeCategory"]');
            
            // 초기 상태 설정
            updateCategoryDisplay(travelTypeSelect.value);
            
            travelTypeSelect.addEventListener('change', function() {
                updateCategoryDisplay(this.value);
            });
            
            function updateCategoryDisplay(selectedType) {
                // 모든 카테고리 숨기기
                domesticDiv.style.display = 'none';
                overseasDiv.style.display = 'none';
                themeDiv.style.display = 'none';
                
                // 모든 select의 disabled 속성을 true로 설정
                domesticSelect.disabled = true;
                overseasSelect.disabled = true;
                themeSelect.disabled = true;
                
                // 선택된 타입에 따라 해당 카테고리만 표시하고 활성화
                switch(selectedType) {
                    case 'DOMESTIC':
                        domesticDiv.style.display = 'block';
                        domesticSelect.disabled = false;
                        break;
                    case 'OVERSEAS':
                        overseasDiv.style.display = 'block';
                        overseasSelect.disabled = false;
                        break;
                    case 'THEME':
                        themeDiv.style.display = 'block';
                        themeSelect.disabled = false;
                        break;
                }
                
                // 숨겨진 select들의 값을 초기화
                if (domesticSelect.disabled) domesticSelect.value = '';
                if (overseasSelect.disabled) overseasSelect.value = '';
                if (themeSelect.disabled) themeSelect.value = '';
            }
        });

        function deleteImage(index, button) {
            if (!confirm('이미지를 삭제하시겠습니까?')) {
                return;
            }

            const imageItem = button.closest('.image-item');
            const itemId = [[${itemFormDto.id}]];
            
            ajaxRequest(
                `/admin/item/${itemId}/image/${index}`,
                'DELETE',
                {},
                function(result) {
                    imageItem.remove();
                    reorderImageLabels();
                }
            );
        }

        function reorderImageLabels() {
            const container = document.getElementById('imageContainer');
            const labels = container.getElementsByTagName('label');
            for (let i = 0; i < labels.length; i++) {
                labels[i].textContent = `${i + 1}번째 상품 이미지`;
            }
        }

        function addImageField(mode) {
            const container = mode === 'edit' ? 
                document.getElementById('editImageContainer') : 
                document.getElementById('newImageContainer');
            const imageItems = container.getElementsByClassName('image-item');
            
            if (imageItems.length >= 5) {
                alert('이미지는 최대 5개까지만 등록 가능합니다.');
                return;
            }

            const newItem = document.createElement('div');
            newItem.className = 'image-item mb-3';
            
            if (mode === 'edit') {
                newItem.innerHTML = `
                    <div class="form-group">
                        <label>${imageItems.length + 1}번째 상품 이미지</label>
                        <div class="border p-2">
                            <input type="file" class="form-control image-input" name="itemImageFile">
                            <button type="button" class="btn btn-outline-danger mt-2" onclick="removeImageField(this)">삭제</button>
                        </div>
                    </div>
                `;
            } else {
                newItem.innerHTML = `
                    <div class="form-group">
                        <label>${imageItems.length + 1}번째 상품 이미지</label>
                        <input type="file" class="form-control" name="itemImageFile">
                        <button type="button" class="btn btn-outline-danger mt-2" onclick="removeImageField(this)">삭제</button>
                    </div>
                `;
            }
            
            container.appendChild(newItem);
        }

        function removeImageField(button) {
            const imageItem = button.closest('.image-item');
            const container = imageItem.closest('.image-container');
            imageItem.remove();
            
            // 번호 재정렬
            const labels = container.getElementsByTagName('label');
            for (let i = 0; i < labels.length; i++) {
                labels[i].textContent = `${i + 1}번째 상품 이미지`;
            }
        }

        function goBack() {
            history.back();
        }
    </script>
</th:block>

</html> 