<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<th:block layout:fragment="css">
    <style>
        .calendar-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card {
            height: 100%;  /* 카드 높이를 100%로 설정 */
        }

        .flatpickr-months {
            flex-shrink: 0;
            padding: 10px 0;
        }

        .flatpickr-weekdays {
            flex-shrink: 0;
        }

        .flatpickr-days {
            flex: 1;
            display: flex !important;
            max-width: none !important;
            width: 100% !important;
        }

        /* 카드 본문 높이 계산 시 패딩을 포함하도록 설정 */
        .card-body {
            height: calc(100% - 56px);  /* 헤더 높이를 제외한 나머지 공간 */
            padding: 1.5rem;
            box-sizing: border-box; /* 패딩을 포함한 높이 계산 */
        }

        /* 달력 컨테이너가 부모 카드 본문 영역을 채우도록 설정 */
        .calendar-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .flatpickr-calendar {
            background: transparent;
            opacity: 1;
            display: flex;
            position: relative;
            width: 100% !important;
            height: 100% !important;
            box-sizing: border-box;
            touch-action: manipulation;
            background: #fff;
            box-shadow: none;
        }

        .dayContainer {
            width: 100%;
            min-width: 100%;
            max-width: 100%;
            display: grid !important;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            padding: 0;
        }

        .flatpickr-day {
            height: auto !important;
            max-height: none !important;
            line-height: 1.5 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            margin: 1px !important;
            flex: 1;
        }

        .day-price {
            font-size: 0.85em;
            margin-top: 4px;
        }

        /* 달력 헤더(월, 년도) 스타일 */
        .flatpickr-current-month {
            font-size: 1.5em !important;
            padding: 10px 0 !important;
        }

        .flatpickr-current-month .cur-month {
            font-weight: bold !important;
        }

        .flatpickr-current-month .cur-year {
            font-size: 1em !important;
        }

        /* 화살표 크기 증가 */
        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            padding: 10px !important;
        }

        .flatpickr-months .flatpickr-prev-month svg,
        .flatpickr-months .flatpickr-next-month svg {
            width: 16px !important;
            height: 16px !important;
        }

        .flatpickr-day {
            height: 60px !important;
            line-height: 25px !important;
            padding: 5px !important;
        }

        .flatpickr-day.selected {
            background: #3498db !important;
            border-color: #3498db !important;
        }

        /* 기존 상품 정보 관련 스타일 유지 */
        .product-info .info-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .product-info .label {
            color: #666;
            flex: 1;
        }

        .product-info .value {
            font-weight: bold;
            color: #2c3e50;
        }

        .product-image {
            position: relative;
            padding-top: 66.67%;
            overflow: hidden;
        }

        .product-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-title {
            color: #2c3e50;
            font-weight: bold;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            z-index: 100;
        }

        /* 컨테이너 높이 설정 */
        .container-fluid {
            height: calc(100vh - 150px); /* 상단 여백을 제외한 높이 */
        }

        .row {
            height: 100%;
        }

        .col-md-8, .col-md-4 {
            height: 100%;
        }

        .calendar-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .flight-info {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
        }

        .price-range {
            color: #e74c3c;
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding: 10px;
            background: #fff3f3;
            border-radius: 6px;
        }

        .price-range span {
            font-weight: bold;
        }

        .flatpickr-day {
            border-radius: 8px;
            height: 80px !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
        }

        .flatpickr-day.selected {
            background: #3498db !important;
            border-color: #3498db !important;
        }

        .day-price {
            font-size: 0.8em;
            margin-top: 5px;
            color: #e74c3c;
            font-weight: bold;
        }

        .flight-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .status-available {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-unavailable {
            background: #ffebee;
            color: #c62828;
        }

        .flight-details {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .flight-route {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .route-arrow {
            color: #3498db;
            font-size: 1.2em;
        }


        .airplane-icon {
            font-size: 3em;
            animation: fly 2s infinite linear;
        }

        @keyframes fly {
            0% { transform: translateX(-50px) translateY(0); }
            50% { transform: translateX(50px) translateY(-20px); }
            100% { transform: translateX(-50px) translateY(0); }
        }
    </style>
</th:block>

<div layout:fragment="content">
    <div class="container-fluid my-4">
        <div class="row">
            <!-- 달력 섹션 -->
            <div class="col-lg-8">
                <div class="calendar-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>여행 일정 선택</h3>
                        <div class="flight-status">
                            <span class="status-indicator status-available">예약가능</span>
                            <span class="status-indicator status-pending">대기예약</span>
                        </div>
                    </div>
                    
                    <div class="price-range">
                        최저 <span th:text="${#numbers.formatInteger(minPrice, 0, 'COMMA')}">0</span>원 ~ 
                        최고 <span th:text="${#numbers.formatInteger(maxPrice, 0, 'COMMA')}">0</span>원
                    </div>

                    <div id="calendar"></div>
                </div>
            </div>

            <!-- 상품 정보 섹션 -->
            <div class="col-lg-4">
                <div class="product-info-section">
                    <div id="selectedDateInfo" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h5>선택하신 일정</h5>
                                <p>출발일: <span id="departureDate"></span></p>
                                <p>도착일: <span id="returnDate"></span></p>
                                <p>잔여 좌석: <span id="remainingSeats"></span>석</p>
                                <p>총 금액: <span id="totalPrice"></span>원</p>
                                <button id="reserveBtn" class="btn btn-primary w-100" disabled>
                                    예약하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 예약 정보 표시 영역 -->

</div>

<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script th:inline="javascript">
        const prices = /*[[${prices}]]*/ {};
        const duration = /*[[${item.duration}]]*/ 0;
        const remainingSeats = /*[[${remainingSeats}]]*/ {};
        
        document.addEventListener('DOMContentLoaded', function() {
            const calendar = flatpickr("#calendar", {
                inline: true,
                mode: "single",
                minDate: "today",
                disable: [],
                locale: "ko",
                defaultDate: "today",
                onChange: function(selectedDates) {
                    if (selectedDates.length > 0) {
                        updateSelectedDateInfo(selectedDates[0]);
                    }
                },
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    const dateStr = dayElem.dateObj.toISOString().split('T')[0];
                    const price = prices[dateStr];
                    
                    if (price) {
                        const priceDiv = document.createElement('div');
                        priceDiv.className = 'day-price';
                        const priceInManwon = (price / 10000).toFixed(1);
                        priceDiv.textContent = `${priceInManwon}만원`;
                        dayElem.appendChild(priceDiv);
                    }
                }
            });
        });

        function updateSelectedDateInfo(selectedDate) {
            const dateStr = selectedDate.toISOString().split('T')[0];
            const returnDate = new Date(selectedDate);
            returnDate.setDate(returnDate.getDate() + duration - 1);
            const remainingSeat = remainingSeats[dateStr];

            const price = prices[dateStr];
            if (price) {
                document.getElementById('departureDate').textContent = dateStr;
                document.getElementById('returnDate').textContent = 
                    returnDate.toISOString().split('T')[0];
                document.getElementById('remainingSeats').textContent =
                    remainingSeat.toLocaleString();
                document.getElementById('totalPrice').textContent = 
                    price.toLocaleString();
                document.getElementById('selectedDateInfo').style.display = 'block';
                
                // 예약하기 버튼 활성화 및 URL 업데이트
                const reserveBtn = document.getElementById('reserveBtn');
                reserveBtn.disabled = false;
                reserveBtn.onclick = function() {
                    location.href = `/item/${/*[[${item.id}]]*/'0'}/detail?reservationDate=${dateStr}`;
                };
            }
        }
    </script>
</th:block>
</html>